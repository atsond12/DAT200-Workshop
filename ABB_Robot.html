<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="./favicon.ico" />
    <title>ABB Robot</title>

    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
    </style>

    <!-- Import map: map the bare specifier "three" to the local module build. -->
    <script type="importmap">
      {
        "imports": {
          "three": "./lib/three.js-master/build/three.module.js",
          "OrbitControls": "./lib/three.js-master/examples/jsm/controls/OrbitControls.js",
          "dat.GUI": "./lib/dat.gui/dat.gui.module.js",
          "Stats": "./lib/three.js-master/examples/jsm/libs/stats.module.js",
          "GLTFLoader": "./lib/three.js-master/examples/jsm/loaders/GLTFLoader.js"
        }
      }
    </script>
  </head>
  <body>
    <script type="module" defer>
      import { world } from "./simpleWorld.js";
      import * as THREE from "three";
      import { GLTFLoader } from "GLTFLoader";
      import * as dat from "dat.GUI";

      const deg = Math.PI / 180;
      const abbModel = {
        baseRotSpeed: 0,
      };
      //----- Functions -----------------------------------------

      function ABBModelObjectLoad(aObject) {
        if (aObject.isMesh) {
          aObject.castShadow = true;
          aObject.receiveShadow = true;
        } else if (aObject.isGroup) {
          abbModel[aObject.name] = aObject;
        }
      }

      function ABBModelOnLoad(aGLTF) {
        console.log("ABB model loading . . ." + aGLTF.toString());
        const abbRobot = aGLTF.scene;
        aGLTF.scene.traverse(ABBModelObjectLoad);
        abbRobot.scale.set(7, 7, 7);
        world.scene.add(abbRobot);
        setInterval(animate, 20);
        addGUI();
      }

      function addSpotLight() {
        const light = new THREE.SpotLight("#FFFFFF", 20);
        light.position.set(2, 25, 2);
        light.angle = 30 * deg;
        light.distance = 50;
        light.decay = 1;
        //Shadow options
        light.castShadow = true;
        light.penumbra = 0.5;
        light.shadow.bias = -0.0005;

        const target = new THREE.Object3D();
        target.position.set(0, 0, 0);
        world.scene.add(target);
        light.target = target;
        world.scene.add(light);
        //const helper = new THREE.SpotLightHelper(light);
        //world.scene.add(helper);
      }

      function addDirectionalLight() {
        let light = new THREE.DirectionalLight("#FFFFFF", 0.5);
        light.position.set(10, 10, 10);
        world.scene.add(light);
        light = new THREE.DirectionalLight("#FFFFFF", 0.5);
        light.position.set(-10, 10, -10);
        world.scene.add(light);
      }

      function animate() {
        abbModel["Link_01"].rotation.y += abbModel.baseRotSpeed / 1000;
      }

      function addAtmosphere() {
        world.scene.background = new THREE.Color("#AAAAAA");
        world.scene.fog = new THREE.Fog("#AAAAAA", 1, 70);
        world.renderer.setClearColor(world.scene.background, 1);
      }

      function addGUI() {
        const gui = new dat.GUI();
        const folder = gui.addFolder("ABB Robot");
        folder.add(abbModel, "baseRotSpeed", -100, 100, 1).name("Base Rotation");
        folder.add(abbModel["Link_02"].rotation, "z", -180 * deg, 60 * deg, 0.01).name("Shoulder");
        folder.add(abbModel["Link_03"].rotation, "z", -45 * deg, 240 * deg, 0.01).name("Elbow");
        folder.add(abbModel["Link_04"].rotation, "x", -360 * deg, 360 * deg, 0.01).name("Wrist");
        folder.add(abbModel["Link_05"].rotation, "z", -130 * deg, 120 * deg, 0.01).name("Weld Gun");
        folder.open();
      }

      //----- Main Code ------------------------------------------
      const loader = new GLTFLoader();
      addAtmosphere();
      addSpotLight();
      addDirectionalLight();
      loader.load("./models/robot/ABB_Robot_01.gltf", ABBModelOnLoad);

      document.body.appendChild(world.renderer.domElement);
    </script>
  </body>
</html>
